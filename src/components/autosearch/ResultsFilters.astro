---
interface Props {
  currentFilters: {
    stockType?: string;
    make?: string;
    maxPrice?: string;
    zip?: string;
  };
}

const { currentFilters } = Astro.props;
---

<aside class="results-filters">
  <div class="filters-header">
    <h3>Filters</h3>
    <a href="/autosearch/shopping/results" class="clear-filters">Clear All</a>
  </div>

  <form id="filters-form" action="/autosearch/shopping/results" method="get">
    
    <div class="filter-section">
      <label class="filter-label">New/Used</label>
      <select name="stockType" class="filter-select">
        <option value="">All</option>
        <option value="new" selected={currentFilters.stockType === 'new'}>New</option>
        <option value="used" selected={currentFilters.stockType === 'used'}>Used</option>
        <option value="cpo" selected={currentFilters.stockType === 'cpo'}>Certified Pre-Owned</option>
      </select>
    </div>

    <div class="filter-section">
      <label class="filter-label">Make</label>
      <select name="make" class="filter-select">
        <option value="">All Makes</option>
        <option value="Toyota" selected={currentFilters.make === 'Toyota'}>Toyota</option>
        <option value="Honda" selected={currentFilters.make === 'Honda'}>Honda</option>
        <option value="Ford" selected={currentFilters.make === 'Ford'}>Ford</option>
        <option value="Chevrolet" selected={currentFilters.make === 'Chevrolet'}>Chevrolet</option>
        <option value="BMW" selected={currentFilters.make === 'BMW'}>BMW</option>
        <option value="Mercedes-Benz" selected={currentFilters.make === 'Mercedes-Benz'}>Mercedes-Benz</option>
      </select>
    </div>

    <div class="filter-section">
      <label class="filter-label">Max Price</label>
      <select name="maxPrice" class="filter-select">
        <option value="">No Max Price</option>
        <option value="10000" selected={currentFilters.maxPrice === '10000'}>$10,000</option>
        <option value="20000" selected={currentFilters.maxPrice === '20000'}>$20,000</option>
        <option value="30000" selected={currentFilters.maxPrice === '30000'}>$30,000</option>
        <option value="40000" selected={currentFilters.maxPrice === '40000'}>$40,000</option>
        <option value="50000" selected={currentFilters.maxPrice === '50000'}>$50,000</option>
      </select>
    </div>

    <div class="filter-section">
      <label class="filter-label">ZIP Code</label>
      <input 
        type="text" 
        name="zip" 
        value={currentFilters.zip || ''} 
        class="filter-input"
        placeholder="Enter ZIP"
      />
    </div>

    <button type="submit" class="apply-btn">Apply Filters</button>
  </form>
</aside>

<script>
  import { navigate } from 'astro:transitions/client';

  let initialized = false;
  let timeout: ReturnType<typeof setTimeout> | null = null;
  let isNavigating = false;

  function initFilters() {
    const form = document.getElementById('filters-form') as HTMLFormElement;
    if (!form) {
      // Retry if form not ready yet
      if (!initialized) {
        setTimeout(initFilters, 100);
      }
      return;
    }

    // Prevent duplicate initialization
    if ((form as any).__filtersInitialized) {
      return;
    }
    (form as any).__filtersInitialized = true;

    const selects = form.querySelectorAll('select');
    const inputs = form.querySelectorAll('input[type="text"]');

    const handleFilterChange = () => {
        // Prevent multiple rapid navigations
        if (isNavigating) return;
        isNavigating = true;

        const formData = new FormData(form);
        const currentParams = new URLSearchParams(window.location.search);
        
        // Merge form data into current params
        for (const [key, value] of formData.entries()) {
            const stringValue = value.toString().trim();
            if (stringValue) {
                currentParams.set(key, stringValue);
            } else {
                currentParams.delete(key);
            }
        }

        // Always reset to page 1 when filters change
        currentParams.delete('page');
        
        // Use current pathname to ensure we stay on the same page
        const baseUrl = window.location.pathname;
        const queryString = currentParams.toString();
        const newUrl = queryString ? `${baseUrl}?${queryString}` : baseUrl;
        
        try {
            // Use View Transitions navigate for SPA-like feel
            navigate(newUrl);
        } catch (e) {
            // Fallback if navigate fails
            console.error('Navigation error:', e);
            window.location.href = newUrl;
        } finally {
          // Reset navigation flag after a short delay
          setTimeout(() => {
            isNavigating = false;
          }, 300);
        }
    };

    // Prevent default form submission and use our handler
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      handleFilterChange();
    });

    selects.forEach(select => {
      select.addEventListener('change', handleFilterChange);
    });
    
    // Debounce input changes (like ZIP)
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            if (timeout) clearTimeout(timeout);
            timeout = setTimeout(handleFilterChange, 500);
        });
    });

    initialized = true;
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilters);
  } else {
    initFilters();
  }

  // Re-initialize after View Transitions (reset flag)
  document.addEventListener('astro:page-load', () => {
    initialized = false;
    isNavigating = false;
    initFilters();
  });
</script>

<style>
  .results-filters {
    background: #fff;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    position: relative;
    will-change: auto;
  }

  .filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .filters-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: #333;
  }

  .clear-filters {
    font-size: 0.875rem;
    color: #4b2c8e;
    text-decoration: none;
  }

  .clear-filters:hover {
    text-decoration: underline;
  }

  .filter-section {
    margin-bottom: 1.5rem;
  }

  .filter-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .filter-select, .filter-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.95rem;
    box-sizing: border-box;
    transition: border-color 0.15s ease;
    background: #fff;
  }

  .filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: #4b2c8e;
  }

  .filter-select:active {
    transform: none;
  }

  .apply-btn {
    width: 100%;
    padding: 0.75rem;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    display: none; /* Hidden because we auto-submit on change, but good for mobile/fallback */
  }

  @media (max-width: 768px) {
    .apply-btn {
      display: block;
    }
  }
</style>

