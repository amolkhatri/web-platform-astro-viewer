---
import "./VehicleCard.css";
import { graphqlQuery } from "../lib/graphql-client";

interface Props {
  vehicleId?: string;
  vehicle?: any; // For when data is already fetched
}

const { vehicleId, vehicle: vehicleProp } = Astro.props;

let vehicle = vehicleProp;

// Fetch from GraphQL if only ID provided
if (vehicleId && !vehicle) {
  const VEHICLE_QUERY = `
    query GetVehicle($id: ID!) {
      vehicle(id: $id) {
        id
        year
        make
        model
        trim
        vin
        stockNumber
        displayableInventoryStatus
        pricing {
          featuredPrice
          msrp
          salePrice
        }
        specs {
          engine {
            description
          }
          transmission {
            transmission
          }
          drivetrain
        }
        colors {
          exterior {
            name
            baseColor
          }
        }
        photos {
          mainPhoto {
            path
            title
          }
        }
      }
    }
  `;

  try {
    const data = await graphqlQuery<{ vehicle: any }>(VEHICLE_QUERY, { id: vehicleId });
    vehicle = data.vehicle;
  } catch (error) {
    console.error('Error fetching vehicle:', error);
    vehicle = null;
  }
}

if (!vehicle) {
  return null;
}

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    maximumFractionDigits: 0,
  }).format(price);
};

// Create a placeholder SVG image as data URI
const createPlaceholderImage = (make: string, model: string, year: number) => {
  const text = `${year} ${make} ${model}`.trim();
  const svg = `<svg width="800" height="450" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#e5e7eb;stop-opacity:1" /><stop offset="100%" style="stop-color:#d1d5db;stop-opacity:1" /></linearGradient></defs><rect width="800" height="450" fill="url(#grad)"/><g transform="translate(400, 200)"><path d="M-80,-40 L80,-40 L100,-20 L100,20 L80,40 L-80,40 L-100,20 L-100,-20 Z" fill="#9ca3af" opacity="0.3"/><circle cx="-50" cy="0" r="15" fill="#6b7280" opacity="0.4"/><circle cx="50" cy="0" r="15" fill="#6b7280" opacity="0.4"/><text x="0" y="80" font-family="Arial, sans-serif" font-size="24" fill="#6b7280" text-anchor="middle" font-weight="bold">${year} ${make}</text><text x="0" y="110" font-family="Arial, sans-serif" font-size="18" fill="#9ca3af" text-anchor="middle">${model}</text></g></svg>`;
  // URL encode the SVG for use in data URI
  return `data:image/svg+xml,${encodeURIComponent(svg)}`;
};

// Get image URL and treat empty strings as null
const rawImageUrl = vehicle.photos?.mainPhoto?.path;
const imageUrl = rawImageUrl && rawImageUrl.trim().length > 0 ? rawImageUrl : null;
const placeholderUrl = createPlaceholderImage(
  vehicle.make || 'Vehicle',
  vehicle.model || '',
  vehicle.year || new Date().getFullYear()
);
---

<div class="vehicle-card-detailed">
  <div class={`card-image-container ${!imageUrl ? 'has-placeholder' : ''}`} id={`card-container-${vehicle.id}`}>
    <div class="card-badges">
      <span class="badge new">New</span>
      <span class="badge stock">{vehicle.displayableInventoryStatus}</span>
    </div>
    <a href={`/vehicle/${vehicle.id}`} class="block h-full">
      {imageUrl ? (
        <img
          src={imageUrl}
          alt={`${vehicle.year} ${vehicle.make} ${vehicle.model}`}
          class="card-image"
          loading="lazy"
          data-placeholder={placeholderUrl}
          data-vehicle-id={vehicle.id}
          onerror="handleImageError(this)"
        />
      ) : (
        <img
          src={placeholderUrl}
          alt={`${vehicle.year} ${vehicle.make} ${vehicle.model} - Image not available`}
          class="card-image placeholder-image"
          loading="lazy"
        />
      )}
    </a>
  </div>

  <div class="card-details">
    <div class="vehicle-header">
      <div class="vehicle-year-make">{vehicle.year} {vehicle.make}</div>
      <a href={`/vehicle/${vehicle.id}`} class="hover:underline text-inherit">
        <h3 class="vehicle-model-trim">
          {vehicle.model} {vehicle.trim ? vehicle.trim : ''}
        </h3>
      </a>
    </div>

    <div class="specs-grid">
      <div class="spec-item" title="Engine">
        <span>‚öôÔ∏è</span>
        {vehicle.specs.engine.description}
      </div>
      <div class="spec-item" title="Transmission">
        <span>üïπÔ∏è</span>
        {vehicle.specs.transmission.transmission}
      </div>
      <div class="spec-item" title="Drivetrain">
        <span>üöô</span>
        {vehicle.specs.drivetrain}
      </div>
      <div class="spec-item" title="Exterior Color">
        <span>üé®</span>
        {vehicle.colors.exterior.name}
      </div>
      <div class="spec-item" title="Stock Number">
        <span>#Ô∏è‚É£</span>
        {vehicle.stockNumber}
      </div>
    </div>

    <div class="pricing-section">
      {vehicle.pricing.msrp && (
        <div class="price-row">
          <span class="price-label">MSRP</span>
          <span class="price-value msrp">{formatPrice(vehicle.pricing.msrp)}</span>
        </div>
      )}
      <div class="price-row">
        <span class="price-label">Sale Price</span>
        <span class="price-value final">
          {formatPrice(vehicle.pricing.featuredPrice || vehicle.pricing.salePrice || 0)}
        </span>
      </div>
    </div>

    <div class="card-actions">
      <a href={`/vehicle/${vehicle.id}`} class="btn btn-outline text-center no-underline">
        View Details
      </a>
      <button
        class="btn btn-primary"
        type="button"
        hx-get={`/api/eprice/${vehicle.id}`}
        hx-target="#eprice-overlay-root"
        hx-swap="innerHTML"
        aria-controls="eprice-overlay-root"
      >
        Get E-Price
      </button>
    </div>
  </div>
</div>

<script is:inline>
  function handleImageError(img) {
    if (img.dataset.errorHandled) return;
    img.dataset.errorHandled = 'true';
    img.onerror = null;
    
    // Get placeholder from data attribute
    const placeholder = img.dataset.placeholder;
    if (placeholder) {
      img.src = placeholder;
      img.classList.add('placeholder-image');
      
      // Update container and badges
      const container = img.closest('.card-image-container');
      if (container) {
        container.classList.add('has-placeholder');
        
        // Style badges for better visibility
        const badges = container.querySelectorAll('.badge');
        badges.forEach(badge => {
          if (badge.classList.contains('new')) {
            badge.style.cssText = 'background-color: #0066ff !important; color: #ffffff !important; box-shadow: 0 4px 12px rgba(0, 102, 255, 0.5) !important; border: 2px solid #0052cc !important; font-weight: 800 !important; padding: 0.4rem 0.75rem !important; font-size: 0.8rem !important; text-transform: uppercase !important; letter-spacing: 0.5px !important;';
          } else if (badge.classList.contains('stock')) {
            badge.style.cssText = 'background-color: #00a86b !important; color: #ffffff !important; box-shadow: 0 4px 12px rgba(0, 168, 107, 0.5) !important; border: 2px solid #00875a !important; font-weight: 800 !important; padding: 0.4rem 0.75rem !important; font-size: 0.8rem !important; text-transform: uppercase !important; letter-spacing: 0.5px !important;';
          }
        });
      }
    }
  }
</script>

<style>
  /* Light theme override for vehicle cards */
  .vehicle-card-detailed {
    background-color: #ffffff;
    border-color: #e5e7eb;
  }

  .card-details {
    background-color: #ffffff;
    color: #1f2937;
  }

  .vehicle-year-make {
    color: #6b7280;
  }

  .vehicle-model-trim {
    color: #111827;
  }

  .specs-grid {
    color: #374151;
  }

  .price-label {
    color: #6b7280;
  }

  .price-value {
    color: #111827;
  }

  .price-value.final {
    color: #dc2626;
  }

  .btn-outline {
    color: #111827;
    border-color: #d1d5db;
    background-color: #ffffff;
  }

  .btn-outline:hover {
    background-color: #f3f4f6;
    border-color: #9ca3af;
  }

  .btn-primary {
    background-color: #ef4444;
    color: #ffffff;
    border-color: #ef4444;
  }

  .btn-primary:hover {
    background-color: #dc2626;
  }

  .card-image.placeholder-image {
    background-color: #f3f4f6;
    object-fit: contain;
    opacity: 0.95;
  }

  /* Ensure badges appear above images */
  div.vehicle-card-detailed div.card-image-container div.card-badges {
    position: relative;
    z-index: 10 !important;
  }

  /* Bright badge styles - Maximum specificity to override everything */
  div.vehicle-card-detailed div.card-image-container div.card-badges span.badge {
    font-weight: 700 !important;
    padding: 0.5rem 0.75rem !important;
    font-size: 0.8125rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    border-radius: 0.375rem !important;
    border: none !important;
    position: relative;
    z-index: 10 !important;
  }

  div.vehicle-card-detailed div.card-image-container div.card-badges span.badge.new {
    background: #1e40af !important;
    background-image: linear-gradient(to bottom, #3b82f6, #1e40af) !important;
    color: #ffffff !important;
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.6) !important;
  }

  div.vehicle-card-detailed div.card-image-container div.card-badges span.badge.stock {
    background: #15803d !important;
    background-image: linear-gradient(to bottom, #22c55e, #15803d) !important;
    color: #ffffff !important;
    box-shadow: 0 4px 12px rgba(21, 128, 61, 0.6) !important;
  }

  /* SUPER bright badges for placeholder images - Maximum visibility */
  div.vehicle-card-detailed div.card-image-container.has-placeholder div.card-badges span.badge.new {
    background: #1d4ed8 !important;
    background-image: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%) !important;
    color: #ffffff !important;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.8), 0 4px 12px rgba(30, 64, 175, 0.6) !important;
    font-weight: 900 !important;
    padding: 0.65rem 1rem !important;
    font-size: 0.9375rem !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
  }

  div.vehicle-card-detailed div.card-image-container.has-placeholder div.card-badges span.badge.stock {
    background: #16a34a !important;
    background-image: linear-gradient(135deg, #22c55e 0%, #14532d 100%) !important;
    color: #ffffff !important;
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.8), 0 4px 12px rgba(21, 128, 61, 0.6) !important;
    font-weight: 900 !important;
    padding: 0.65rem 1rem !important;
    font-size: 0.9375rem !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
  }
</style>
