---
import Layout from "../../layouts/Layout.astro";
import { fetchStrapi, type Article } from "../../lib/strapi";

export const prerender = false; // Enable SSR for dynamic routing

const { slug } = Astro.params;

let article: Article | null = null;
let error = null;

try {
    const response = await fetchStrapi<Article>("articles", {
        "filters[slug][$eq]": slug as string,
    });

    if (response.data.length > 0) {
        article = response.data[0];
    } else {
        return Astro.redirect("/404");
    }
} catch (e) {
    console.error(`Failed to fetch article with slug ${slug}:`, e);
    error = "Failed to load article.";
}
---

<Layout title={article?.title || "Article not found"}>
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <a
            href="/blog"
            class="inline-flex items-center text-blue-600 hover:underline mb-6"
        >
            &larr; Back to Blog
        </a>

        {
            error && (
                <div
                    class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6"
                    role="alert"
                >
                    <p>{error}</p>
                </div>
            )
        }

        {
            article && (
                <article>
                    <header class="mb-8">
                        <h1 class="text-4xl font-bold mb-4">{article.title}</h1>
                        <div class="text-gray-500">
                            <time datetime={article.publishedAt}>
                                {new Date(
                                    article.publishedAt,
                                ).toLocaleDateString(undefined, {
                                    year: "numeric",
                                    month: "long",
                                    day: "numeric",
                                })}
                            </time>
                        </div>
                    </header>

                    <div class="prose prose-lg max-w-none">
                        <p class="text-xl text-gray-700 leading-relaxed mb-6 font-medium">
                            {article.description}
                        </p>

                        {/* 
            Note: Since the schema only provided description, we are displaying that.
            If there is a rich text content field (e.g. 'content' or 'blocks'), 
            it would be rendered here, potentially using a Markdown parser or blocks renderer.
          */}
                    </div>
                </article>
            )
        }
    </div>
</Layout>
