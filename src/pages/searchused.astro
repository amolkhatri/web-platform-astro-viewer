---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SearchFilter from "../components/SearchFilter.astro";
import SortBar from "../components/SortBar.astro";
import VehicleList from "../components/VehicleList.astro";
import VehicleListSkeleton from "../components/VehicleListSkeleton.astro";
import Pagination from "../components/Pagination.astro";
import vehiclesData from "../data/vehicles.json";
import { isBot } from "../utils/isBot";
import {
    parseFilters,
    filterVehicles,
    calculateFilterCounts,
    type Vehicle,
} from "../utils/filterUtils";

import homeData from "../data/home.json";

const allVehicles = vehiclesData as Vehicle[];

// Parse filters from URL query parameters
const currentFilters = parseFilters(Astro.url.searchParams);

// Filter vehicles based on current filters
const filteredVehicles = filterVehicles(allVehicles, currentFilters);

// Calculate dynamic filter counts
const filterCounts = calculateFilterCounts(allVehicles, currentFilters);

// Pagination Logic
const ITEMS_PER_PAGE = 12;
const currentPage = parseInt(Astro.url.searchParams.get("page") || "1");
const totalPages = Math.ceil(filteredVehicles.length / ITEMS_PER_PAGE);
const paginatedVehicles = filteredVehicles.slice(
    (currentPage - 1) * ITEMS_PER_PAGE,
    currentPage * ITEMS_PER_PAGE,
);

// Detect if the request is from a bot
const userAgent = Astro.request.headers.get("user-agent") || "";
const isBotRequest = isBot(userAgent);
---

<Layout title="Search Used Inventory | Passport Mazda">
    <Header {...homeData.header} />

    <main class="search-page-main">
        <div class="container mx-auto px-4 py-8">
            <div class="page-header mb-6">
                <h1 class="text-3xl font-bold text-gray-900">
                    Used Mazda Inventory
                </h1>
            </div>

            <div class="search-layout">
                <!-- Sidebar -->
                <div class="search-sidebar">
                    <SearchFilter
                        currentFilters={currentFilters}
                        filterCounts={filterCounts}
                    />
                </div>

                <!-- Content -->
                <div class="search-content">
                    <SortBar count={filteredVehicles.length} />

                    {
                        isBotRequest ? (
                            <VehicleList vehicles={paginatedVehicles} />
                        ) : (
                            <VehicleList
                                server:defer
                                vehicles={paginatedVehicles}
                            >
                                <VehicleListSkeleton slot="fallback" />
                            </VehicleList>
                        )
                    }

                    <Pagination
                        currentPage={currentPage}
                        totalPages={totalPages}
                    />
                </div>
            </div>
        </div>
    </main>

    <Footer {...homeData.footer} />
</Layout>

<style>
    .search-page-main {
        background: var(--md-sys-color-surface);
        min-height: 100vh;
    }

    .page-header h1 {
        color: var(--heading-color);
    }

    .search-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    @media (min-width: 1024px) {
        .search-layout {
            grid-template-columns: 280px 1fr;
        }
    }
</style>
