---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SearchFilterGraphQL from "../components/SearchFilterGraphQL.astro";
import VehicleCardGraphQL from "../components/VehicleCardGraphQL.astro";
import { graphqlQuery } from "../lib/graphql-client";
import {
  parseGraphQLFilters,
  convertGraphQLFiltersToAggregations,
} from "../utils/graphqlFilterUtils";
import {
  SEARCH_WITH_AGGREGATIONS_QUERY,
  buildSearchVariables,
} from "../graphql/queries/vehicleSearch";
import "../components/VehicleList.css";
import homeData from "../data/home.json";

// Parse filters from URL
const filters = parseGraphQLFilters(Astro.url.searchParams);

// Get pagination params
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const limit = 20;
const offset = (page - 1) * limit;

// Get sort params
const sortField = Astro.url.searchParams.get("sortField") || "year";
const sortDirection = (Astro.url.searchParams.get("sortDirection") ||
  "DESC") as "ASC" | "DESC";

// Build GraphQL variables
const variables = buildSearchVariables(filters, {
  limit,
  offset,
  sortField,
  sortDirection,
});

// Fetch data from GraphQL
let searchResults: any = null;
let error: string | null = null;

try {
  searchResults = await graphqlQuery(SEARCH_WITH_AGGREGATIONS_QUERY, variables);
} catch (e) {
  error = e instanceof Error ? e.message : "Failed to fetch vehicles";
  console.error("[SearchInventory] Error:", error);
}

// Extract data
const vehicles = searchResults?.searchVehicles?.vehicles || [];
const totalCount = searchResults?.searchVehicles?.summary?.totalCount || 0;

// Extract filters from search results for aggregations
const searchFilters = searchResults?.searchVehicles?.filters || [];
let aggregations;
if (searchFilters.length > 0) {
  aggregations = convertGraphQLFiltersToAggregations(searchFilters);
} else {
  aggregations = {
    makes: [],
    models: [],
    years: [],
    statuses: [],
    priceRanges: [],
    bodyTypes: [],
  };
}

// Calculate pagination
const totalPages = Math.ceil(totalCount / limit);
const hasNextPage = page < totalPages;
const hasPrevPage = page > 1;

// Build pagination URLs
function buildPageUrl(pageNum: number): string {
  const params = new URLSearchParams(Astro.url.searchParams);
  params.set("page", pageNum.toString());
  return `${Astro.url.pathname}?${params.toString()}`;
}

// Calculate page numbers for pagination
const pageNumbers: number[] = [];
if (totalPages > 1) {
  const maxPages = Math.min(totalPages, 7);
  for (let i = 0; i < maxPages; i++) {
    let pageNum: number;
    if (totalPages <= 7) {
      pageNum = i + 1;
    } else if (page <= 4) {
      pageNum = i + 1;
    } else if (page >= totalPages - 3) {
      pageNum = totalPages - 6 + i;
    } else {
      pageNum = page - 3 + i;
    }
    pageNumbers.push(pageNum);
  }
}

// Sort options
const sortOptions = [
  { label: "Price: Low to High", field: "price", direction: "ASC" },
  { label: "Price: High to Low", field: "price", direction: "DESC" },
  { label: "Year: Newest", field: "year", direction: "DESC" },
  { label: "Year: Oldest", field: "year", direction: "ASC" },
  { label: "Make A-Z", field: "make", direction: "ASC" },
  { label: "Make Z-A", field: "make", direction: "DESC" },
];

const currentSortLabel =
  sortOptions.find(
    (opt) => opt.field === sortField && opt.direction === sortDirection,
  )?.label || "Year: Newest";
---

<Layout title="Search Inventory | Passport Mazda" enableClientRouter={true}>
  <Header {...homeData.blocks.header} />

  <main class="inventory-search-page">
    <div class="container mx-auto px-4 py-6">
      <!-- Page Header -->
      <div class="page-header mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Search Inventory
        </h1>
        <p class="text-gray-600">
          {totalCount > 0 ? (
            <span>
              <strong>{totalCount.toLocaleString()}</strong> vehicle
              {totalCount !== 1 ? "s" : ""} found
            </span>
          ) : (
            "No vehicles found"
          )}
        </p>
      </div>

      {error && (
        <div class="error-banner mb-4">
          <strong>Error:</strong> {error}
          <p>Please try again or contact support if the problem persists.</p>
        </div>
      )}

      <div class="search-layout">
        <!-- Sidebar with filters -->
        <aside class="filters-sidebar">
          <div class="filters-panel">
            <div class="filters-header">
              <h2 class="filters-title">Filter Results</h2>
              {Object.keys(filters).length > 0 && (
                <a
                  href={Astro.url.pathname}
                  class="clear-filters-link"
                >
                  Clear All
                </a>
              )}
            </div>
            <SearchFilterGraphQL
              currentFilters={filters}
              aggregations={aggregations}
              totalCount={totalCount}
              server:defer
            />
          </div>
        </aside>

        <!-- Main content area -->
        <div class="main-content-area">
          <!-- Sort and View Controls -->
          <div class="controls-bar">
            <div class="results-info">
              Showing {offset + 1}-{Math.min(offset + limit, totalCount)} of{" "}
              {totalCount.toLocaleString()} vehicles
            </div>
            <div class="controls-right">
              <label for="sort-select" class="sort-label">Sort by:</label>
              <select id="sort-select" class="sort-select">
                {sortOptions.map((option) => (
                  <option
                    value={`${option.field}|${option.direction}`}
                    selected={
                      option.field === sortField &&
                      option.direction === sortDirection
                    }
                  >
                    {option.label}
                  </option>
                ))}
              </select>
            </div>
          </div>

          <!-- Vehicle results grid -->
          <div class="vehicle-grid">
            {vehicles.length > 0 ? (
              vehicles.map((vehicle: any) => (
                <VehicleCardGraphQL vehicle={vehicle} server:defer />
              ))
            ) : (
              <div class="no-results-message">
                <h2>No vehicles found</h2>
                <p>Try adjusting your filters to see more results.</p>
                <a href={Astro.url.pathname} class="reset-link">
                  Reset All Filters
                </a>
              </div>
            )}
          </div>

          <!-- Pagination -->
          {totalPages > 1 && (
            <nav class="pagination-nav" aria-label="Pagination">
              <div class="pagination-container">
                {hasPrevPage ? (
                  <a href={buildPageUrl(page - 1)} class="pagination-btn">
                    ← Previous
                  </a>
                ) : (
                  <span class="pagination-btn disabled">← Previous</span>
                )}

                <div class="pagination-pages">
                  {pageNumbers.map((pageNum) => (
                    <a
                      href={buildPageUrl(pageNum)}
                      class={`pagination-page ${
                        pageNum === page ? "active" : ""
                      }`}
                    >
                      {pageNum}
                    </a>
                  ))}
                </div>

                {hasNextPage ? (
                  <a href={buildPageUrl(page + 1)} class="pagination-btn">
                    Next →
                  </a>
                ) : (
                  <span class="pagination-btn disabled">Next →</span>
                )}
              </div>
            </nav>
          )}
        </div>
      </div>
    </div>
  </main>

  <Footer {...homeData.blocks.footer} />
</Layout>

<script>
  import { navigate } from "astro:transitions/client";

  // Handle sort change
  function initSort() {
    const sortSelect = document.getElementById(
      "sort-select",
    ) as HTMLSelectElement;
    if (!sortSelect) return;

    sortSelect.addEventListener("change", () => {
      const [field, direction] = sortSelect.value.split("|");
      const params = new URLSearchParams(window.location.search);
      params.set("sortField", field);
      params.set("sortDirection", direction);
      params.delete("page"); // Reset to page 1 when sorting changes

      const newUrl = `${window.location.pathname}?${params.toString()}`;
      navigate(newUrl);
    });
  }

  // Initialize on page load
  initSort();

  // Re-initialize after view transitions
  document.addEventListener("astro:page-load", initSort);
</script>

<style>
  .inventory-search-page {
    background: #f5f5f5;
    min-height: 100vh;
  }

  .page-header {
    background: #fff;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .page-header h1 {
    color: #1a1a1a;
    margin: 0;
  }

  .error-banner {
    background: #fee;
    border: 1px solid #fcc;
    border-radius: 8px;
    padding: 1rem;
    color: #c33;
  }

  .error-banner strong {
    display: block;
    margin-bottom: 0.5rem;
  }

  .search-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  @media (max-width: 1024px) {
    .search-layout {
      grid-template-columns: 1fr;
    }
  }

  .filters-sidebar {
    position: sticky;
    top: 1rem;
    align-self: start;
    height: fit-content;
  }

  .filters-panel {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .filters-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .filters-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
  }

  .clear-filters-link {
    font-size: 0.875rem;
    color: #0066cc;
    text-decoration: none;
  }

  .clear-filters-link:hover {
    text-decoration: underline;
  }

  .main-content-area {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
  }

  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .results-info {
    color: #666;
    font-size: 0.875rem;
  }

  .controls-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sort-label {
    font-size: 0.875rem;
    color: #666;
  }

  .sort-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: #fff;
    font-size: 0.875rem;
    cursor: pointer;
    min-width: 180px;
  }

  .sort-select:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .vehicle-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .vehicle-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1280px) {
    .vehicle-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .no-results-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
  }

  .no-results-message h2 {
    margin: 0 0 1rem 0;
    color: #1a1a1a;
    font-size: 1.5rem;
  }

  .no-results-message p {
    color: #666;
    margin: 0 0 1.5rem 0;
  }

  .reset-link {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #0066cc;
    color: #fff;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    transition: background 0.2s;
  }

  .reset-link:hover {
    background: #0052a3;
  }

  .pagination-nav {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  .pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .pagination-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #d1d5db;
    background: #fff;
    color: #1a1a1a;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .pagination-btn:hover:not(.disabled) {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  .pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    color: #9ca3af;
  }

  .pagination-pages {
    display: flex;
    gap: 0.25rem;
  }

  .pagination-page {
    min-width: 40px;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    background: #fff;
    color: #1a1a1a;
    text-decoration: none;
    border-radius: 4px;
    text-align: center;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .pagination-page:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  .pagination-page.active {
    background: #0066cc;
    color: #fff;
    border-color: #0066cc;
  }

  @media (max-width: 768px) {
    .controls-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .sort-select {
      width: 100%;
    }

    .pagination-container {
      gap: 0.25rem;
    }

    .pagination-btn,
    .pagination-page {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
  }
</style>


