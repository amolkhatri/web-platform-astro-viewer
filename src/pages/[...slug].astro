---
import PageBuilder from "../components/PageBuilder.astro";
import Layout from "../layouts/Layout.astro";
import MinimalLayout from "../layouts/MinimalLayout.astro";
import SidebarLayout from "../layouts/SidebarLayout.astro";
import MainLayout from "../layouts/MainLayout.astro";
import VehicleMultiSlotLayout from "../layouts/multipleSlot.astro";
import { getPage, getDraftPage, type Page } from "../lib/db";

const { slug } = Astro.params;
const currentSlug = slug || "home"; // Default to home if root

// Support draft preview via ?draft=true
const draftFlag = Astro.url.searchParams.get("draft") === "true";

let pageData: Page | null;

if (draftFlag) {
  // Prefer draft, but fall back to live if draft is missing
  pageData = (await getDraftPage(currentSlug)) ?? (await getPage(currentSlug));
} else {
  pageData = await getPage(currentSlug);
}

const error = null;

const layouts = {
  default: Layout,
  minimal: MinimalLayout,
  sidebar: SidebarLayout,
  main: MainLayout,
  "vehicle-multislot": VehicleMultiSlotLayout,
};

const LayoutComponent =
  layouts[pageData?.layout as keyof typeof layouts] || Layout;
---

<LayoutComponent title={pageData ? pageData.title : "Page Not Found"}>
  <main>
    {
      error ? (
        <div style="text-align: center; padding: 2rem;">
          <h1>404</h1>
          <p>{error}</p>
        </div>
      ) : (
        <PageBuilder blocks={pageData?.blocks || []} />
      )
    }
  </main>
</LayoutComponent>
