---
import PageBuilder from "../components/PageBuilder.astro";
import Layout from "../layouts/Layout.astro";
import MinimalLayout from "../layouts/MinimalLayout.astro";
import SidebarLayout from "../layouts/SidebarLayout.astro";
import MainLayout from "../layouts/MainLayout.astro";
import VehicleMultiSlotLayout from "../layouts/multipleSlot.astro";
import Layout1 from "../layouts/DO/Layout1.astro";
import Layout2 from "../layouts/DO/Layout2.astro";
import Layout3 from "../layouts/DO/Layout3.astro";
import Layout4 from "../layouts/DO/Layout4.astro";
import Layout5 from "../layouts/DO/Layout5.astro";
import Layout6 from "../layouts/DO/Layout6.astro";
import { getPage, getDraftPage, type Page } from "../lib/db";

const { slug } = Astro.params;
const currentSlug = slug || "home"; // Default to home if root

// Support draft preview via ?draft=true
const draftFlag = Astro.url.searchParams.get("draft") === "true";

let pageData: Page | null;

if (draftFlag) {
  // Prefer draft, but fall back to live if draft is missing
  pageData = (await getDraftPage(currentSlug)) ?? (await getPage(currentSlug));
} else {
  pageData = await getPage(currentSlug);
}

const error = null;

const layouts = {
  default: Layout,
  minimal: MinimalLayout,
  sidebar: SidebarLayout,
  main: MainLayout,
  "vehicle-multislot": VehicleMultiSlotLayout,
  layout1: Layout1,
  layout2: Layout2,
  layout3: Layout3,
  layout4: Layout4,
  layout5: Layout5,
  layout6: Layout6,
};

// Layouts that use named slots (block1, block2, etc.)
const slotLayouts = ["layout1", "layout2", "layout3", "layout4", "layout5", "layout6"];

// Use layout from page data, default to "default"
const currentLayout = pageData?.layout || "default";
const LayoutComponent = layouts[currentLayout as keyof typeof layouts] || Layout;
const blocks = pageData?.blocks || [];
const usesSlots = slotLayouts.includes(currentLayout);


---

<LayoutComponent title={pageData ? pageData.title : "Page Not Found"}>
  {error && (
    <main>
      <div style="text-align: center; padding: 2rem;">
        <h1>404</h1>
        <p>{error}</p>
      </div>
    </main>
  )}

  {!error && usesSlots && blocks?.[0] && (
    <div slot="block1">
      <PageBuilder blocks={[blocks[0]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[1] && (
    <div slot="block2">
      <PageBuilder blocks={[blocks[1]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[2] && (
    <div slot="block3">
      <PageBuilder blocks={[blocks[2]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[3] && (
    <div slot="block4">
      <PageBuilder blocks={[blocks[3]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[4] && (
    <div slot="block5">
      <PageBuilder blocks={[blocks[4]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[5] && (
    <div slot="block6">
      <PageBuilder blocks={[blocks[5]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[6] && (
    <div slot="block7">
      <PageBuilder blocks={[blocks[6]]} />
    </div>
  )}

  {!error && usesSlots && blocks?.[7] && (
    <div slot="block8">
      <PageBuilder blocks={[blocks[7]]} />
    </div>
  )}

  {!error && !usesSlots && (
    <main>
      <PageBuilder blocks={blocks || []} />
    </main>
  )}
</LayoutComponent>
